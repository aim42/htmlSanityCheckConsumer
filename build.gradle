buildscript {
    repositories {
        maven {
            url uri('../repo')
        }
        jcenter()
        maven {
            name 'Bintray Asciidoctor repo'
            url  'http://dl.bintray.com/content/aalmiray/asciidoctor'
        }
        mavenCentral()
    }

    dependencies {
        classpath (group: 'org.aim42',
                name: 'htmlSanityCheck',
                version: '0.2.0-SNAPSHOT')

        classpath (group: 'org.asciidoctor',
                    name: 'asciidoctor-gradle-plugin',
                    version: '1.5.0')
    }
}

// ==== path definitions =====
// ===========================

// location of AsciiDoc files
def asciidocSrcPath = "$projectDir/src/asciidoc"

// location of images used in AsciiDoc documentation
def srcImagesPath = "$asciidocSrcPath/images"

// results of asciidoc compilitation (HTML) is stored
// (input for htmlSanityCheck)
def htmlOutputPath = "$buildDir/docs"

// images used by generated html
def targetImagesPath =   htmlOutputPath + "/images"

// where HTMLSanityCheck checkingresults ares stored
def checkingResultsPath = "$buildDir/report/"

// TODO: convert to FileCollection for 1.5.1

// what file to process
def inputFileName = "tryme"

// what file to convert from asciidoc to html
def fileToConvertPath = asciidocSrcPath + "/" + inputFileName + ".adoc"

// what file to check
def fileToCheckPath = htmlOutputPath + "/" + inputFileName + ".html"


// ==== asciidoctor ==========
// ===========================

apply plugin: 'org.asciidoctor.gradle.asciidoctor'

asciidoctor {
    outputDir = new File( htmlOutputPath )
    sourceDocumentNames = files( new File( fileToConvertPath ))
    options = [
            attributes: [
                    imagesdir   : 'images'
            ]
    ]

}


// ==== copy images into build/docs directory =====
task copyImages(
        type: Copy,
        description: 'copy images into build output folder can be resolved '
) {
    from srcImagesPath
    into targetImagesPath
    include( '**/*.jpg', '**/*.png', '**/*.svg')
}


copyImages.mustRunAfter asciidoctor


apply plugin: 'htmlSanityCheck'


htmlSanityCheck {

    // ensure asciidoctor->html runs first
    // and images are copied to build directory
    // TODO: commented to allow checking of other files..
    //dependsOn asciidoctor, copyImages

    // what file to check
    fileToCheck = new File ( fileToCheckPath )

    // where to put results of sanityChecks...
    checkingResultsDir = new File( checkingResultsPath )

    checkExternalLinks = true
}

htmlSanityCheck.mustRunAfter asciidoctor


task info(
        description: "info on several paths"
) <<
        {
            println "project.name         : " + project.name
            println "projectDir           : " + projectDir
            println "buildDir             : " + buildDir
            println "="*100
            println "asciidoc src files   : " + asciidocSrcPath
            println "source images        : " + srcImagesPath
            println "asciidoc html output : " + htmlOutputPath
            println "target images path   : " + targetImagesPath
            println "checkingResultsPath  : " + checkingResultsPath
        }
